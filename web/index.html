<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aika DBA - æ•¸æ“šåº«åˆ†æå·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
            width: 1rem;
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
        }
        .phase-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phase-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .status-running { color: #ffc107; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            .sidebar.show {
                left: 0;
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .mobile-menu-btn {
                display: block !important;
            }
        }
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        .progress-item {
            margin-bottom: 1rem;
        }
        .progress-item .progress-bar {
            transition: width 0.3s ease;
        }
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #6c757d;
            margin-right: 0.5rem;
        }
        .log-level-info { color: #0dcaf0; }
        .log-level-debug { color: #6c757d; }
        .log-level-warn { color: #ffc107; }
        .log-level-error { color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <nav class="sidebar position-fixed" id="sidebar">
        <div class="p-3">
            <h4 class="mb-4">
                <i class="bi bi-database"></i>
                Aika DBA
            </h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')">
                        <i class="bi bi-house-door"></i>
                        å„€è¡¨æ¿
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#prepare" onclick="showSection('prepare')">
                        <i class="bi bi-database-add"></i>
                        çŸ¥è­˜åº«æº–å‚™
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#query" onclick="showSection('query')">
                        <i class="bi bi-chat-dots"></i>
                        è‡ªç„¶èªè¨€æŸ¥è©¢
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#phases" onclick="showSection('phases')">
                        <i class="bi bi-play-circle"></i>
                        Phase åŸ·è¡Œ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#vector" onclick="showSection('vector')">
                        <i class="bi bi-brain"></i>
                        å‘é‡æ•¸æ“šåº«
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#knowledge" onclick="showSection('knowledge'); loadKnowledgeFiles();">
                        <i class="bi bi-folder2-open"></i>
                        çŸ¥è­˜æª”æ¡ˆ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#search" onclick="showSection('search')">
                        <i class="bi bi-search"></i>
                        çŸ¥è­˜æœç´¢
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#status" onclick="showSection('status')">
                        <i class="bi bi-info-circle"></i>
                        ç³»çµ±ç‹€æ…‹
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-house-door me-2"></i>å„€è¡¨æ¿</h2>
                <small class="text-muted">æ•¸æ“šåº«åˆ†æå·¥å…·</small>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="bi bi-database display-4 mb-2"></i>
                            <h5>æ•¸æ“šåº«é€£æ¥</h5>
                            <span class="badge bg-success">æ­£å¸¸</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="bi bi-cpu display-4 mb-2"></i>
                            <h5>ç³»çµ±ç‹€æ…‹</h5>
                            <span class="badge bg-success">é‹è¡Œä¸­</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="bi bi-vector-pen display-4 mb-2"></i>
                            <h5>å‘é‡å­˜å„²</h5>
                            <span class="badge bg-info">å°±ç·’</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="bi bi-robot display-4 mb-2"></i>
                            <h5>AI åˆ†æ</h5>
                            <span class="badge bg-warning">å¯ç”¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>å¿«é€Ÿæ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-primary w-100" onclick="showSection('prepare')">
                                <i class="bi bi-database-add me-2"></i>
                                æº–å‚™çŸ¥è­˜åº«
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-success w-100" onclick="showSection('query')">
                                <i class="bi bi-chat-dots me-2"></i>
                                è‡ªç„¶èªè¨€æŸ¥è©¢
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-info w-100" onclick="showSection('phases')">
                                <i class="bi bi-play-circle me-2"></i>
                                åŸ·è¡Œ Phase
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-warning w-100" onclick="showSection('vector')">
                                <i class="bi bi-brain me-2"></i>
                                æŸ¥çœ‹å‘é‡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Preparation Section -->
        <div id="prepare-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-database-add me-2"></i>çŸ¥è­˜åº«æº–å‚™</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>åŠŸèƒ½èªªæ˜</h5>
                        </div>
                        <div class="card-body">
                            <p>çŸ¥è­˜åº«æº–å‚™åŠŸèƒ½æœƒæƒææ•¸æ“šåº«ä¸­çš„æ‰€æœ‰è¡¨æ ¼ï¼Œåˆ†æå…¶çµæ§‹ã€ç´„æŸå’Œæ¨£æœ¬æ•¸æ“šï¼Œç„¶å¾Œå°‡é€™äº›çŸ¥è­˜å­˜å„²åˆ°å‘é‡æ•¸æ“šåº«ä¸­ï¼Œä»¥ä¾¿å¾ŒçºŒçš„è‡ªç„¶èªè¨€æŸ¥è©¢ä½¿ç”¨ã€‚</p>
                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb me-2"></i>
                                <strong>æç¤ºï¼š</strong>æº–å‚™çŸ¥è­˜åº«é€šå¸¸åªéœ€è¦åŸ·è¡Œä¸€æ¬¡ï¼Œé™¤éæ•¸æ“šåº«çµæ§‹ç™¼ç”Ÿé‡å¤§è®ŠåŒ–ã€‚
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>åŸ·è¡Œæº–å‚™</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary btn-lg w-100 mb-3" onclick="prepareKnowledge()">
                                <i class="bi bi-database-add me-2"></i>
                                é–‹å§‹æº–å‚™çŸ¥è­˜åº«
                            </button>
                            <div id="prepare-status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Query Section -->
        <div id="query-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-chat-dots me-2"></i>è‡ªç„¶èªè¨€æŸ¥è©¢</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>æŸ¥è©¢æ•¸æ“šåº«</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="query-input" class="form-label">è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ</label>
                        <textarea class="form-control" id="query-input" rows="3" placeholder="ä¾‹å¦‚ï¼šçµ±è¨ˆå•†å“éŠ·å”®è¨˜éŒ„ã€é¡¯ç¤ºæ‰€æœ‰å®¢æˆ¶çš„è¨‚å–®ç¸½é¡ã€æŸ¥è©¢æœ€æš¢éŠ·çš„ç”¢å“..."></textarea>
                        <div id="query-suggestions" class="mt-2" style="display: none;">
                            <small class="text-muted">å»ºè­°ï¼š</small>
                            <div id="suggestions-list" class="d-flex flex-wrap gap-1 mt-1"></div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-lg" onclick="executeQuery()">
                        <i class="bi bi-send me-2"></i>
                        åŸ·è¡ŒæŸ¥è©¢
                    </button>
                </div>
            </div>

            <div id="query-results" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-chat-quote me-2"></i>æŸ¥è©¢çµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="query-result-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phases Section -->
        <div id="phases-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-play-circle me-2"></i>Phase åŸ·è¡Œ</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š æ•¸æ“šåº«åˆ†æéšæ®µ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-primary">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-diagram-3 display-4 text-primary"></i>
                                    </div>
                                    <h6 class="card-title">Phase 1</h6>
                                    <p class="card-text small text-muted">æ•¸æ“šåº«æ¶æ§‹åˆ†æ</p>
                                    <button class="btn btn-primary" onclick="triggerPhase('phase1')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-warning">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-search display-4 text-warning"></i>
                                    </div>
                                    <h6 class="card-title">Phase 2 Prefix</h6>
                                    <p class="card-text small text-muted">åˆ—ç´šæ·±åº¦åˆ†æ</p>
                                    <button class="btn btn-warning" onclick="triggerPhase('phase2_prefix')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-success">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-robot display-4 text-success"></i>
                                    </div>
                                    <h6 class="card-title">Phase 2</h6>
                                    <p class="card-text small text-muted">AI å•†æ¥­é‚è¼¯åˆ†æ</p>
                                    <button class="btn btn-success" onclick="triggerPhase('phase2')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-info">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-bar-chart display-4 text-info"></i>
                                    </div>
                                    <h6 class="card-title">Phase 3</h6>
                                    <p class="card-text small text-muted">æ¥­å‹™é‚è¼¯ç¸½çµ</p>
                                    <button class="btn btn-info" onclick="triggerPhase('phase3')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-secondary">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-clipboard-check display-4 text-secondary"></i>
                                    </div>
                                    <h6 class="card-title">Phase 1 Post</h6>
                                    <p class="card-text small text-muted">å•ç­”å›é¥‹èˆ‡æ±ºç­–å½™ç¸½</p>
                                    <button class="btn btn-secondary" onclick="triggerPhase('phase1_post')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card phase-card border-dark">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-arrow-repeat display-4 text-dark"></i>
                                    </div>
                                    <h6 class="card-title">Phase 1 Put</h6>
                                    <p class="card-text small text-muted">å¥—ç”¨æ±ºç­–æ›´æ–° Phase 1</p>
                                    <button class="btn btn-dark" onclick="triggerPhase('phase1_put')">
                                        <i class="bi bi-play me-1"></i>åŸ·è¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="phase-status" class="mt-3"></div>

                    <!-- Progress Display -->
                    <div id="progress-container" class="mt-4" style="display: none;">
                        <h5><i class="bi bi-bar-chart-line me-2"></i>åŸ·è¡Œé€²åº¦</h5>
                        <div id="progress-bars"></div>
                    </div>

                    <!-- Debug Logs Display -->
                    <div id="logs-container" class="mt-4" style="display: none;">
                        <h5><i class="bi bi-terminal me-2"></i>èª¿è©¦æ—¥èªŒ</h5>
                        <div class="card">
                            <div class="card-body">
                                <div id="logs-content" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                                    <div class="text-muted">ç­‰å¾…æ—¥èªŒè¼¸å‡º...</div>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- Vector Database Section -->
        <div id="vector-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-brain me-2"></i>å‘é‡æ•¸æ“šåº«</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>çµ±è¨ˆä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary mb-3" onclick="loadVectorStats()">
                        <i class="bi bi-arrow-clockwise me-2"></i>è¼‰å…¥çµ±è¨ˆä¿¡æ¯
                    </button>
                    <div id="vector-stats"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-search me-2"></i>çŸ¥è­˜æŸ¥è©¢</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="phase-select" class="form-label">é¸æ“‡éšæ®µ</label>
                            <select class="form-select" id="phase-select">
                                <option value="phase1">Phase 1 - æ¶æ§‹åˆ†æ</option>
                                <option value="phase1_post">Phase 1 Post - æ±ºç­–æ•´åˆ</option>
                                <option value="phase2_prefix">Phase 2 Prefix - åˆ—ç´šæ·±åº¦åˆ†æ</option>
                                <option value="phase2">Phase 2 - AI åˆ†æ</option>
                                <option value="phase3">Phase 3 - æ¥­å‹™ç¸½çµ</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="loadPhaseKnowledge()">
                                <i class="bi bi-search me-2"></i>è¼‰å…¥çŸ¥è­˜
                            </button>
                        </div>
                    </div>
                    <div id="phase-knowledge" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Knowledge Section -->
        <div id="knowledge-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-folder2-open me-2"></i>çŸ¥è­˜æª”æ¡ˆ</h2>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="loadKnowledgeFiles()">
                        <i class="bi bi-arrow-clockwise me-1"></i>é‡æ–°æ•´ç†
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                        <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-files me-2"></i>è¼¸å‡ºåˆ—è¡¨</h5>
                        </div>
                        <div class="card-body">
                            <div id="knowledge-files" class="text-muted">å°šæœªè¼‰å…¥è³‡æ–™</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>æª”æ¡ˆå…§å®¹</h5>
                        </div>
                        <div class="card-body">
                            <div id="knowledge-details" class="text-muted mb-3">é¸æ“‡å·¦å´æª”æ¡ˆä»¥æŸ¥çœ‹å…§å®¹ã€‚</div>
                            <pre id="knowledge-content" class="bg-light border rounded p-3 small text-wrap" style="max-height: 480px; overflow: auto;">å°šæœªé¸æ“‡æª”æ¡ˆ</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div id="search-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-search me-2"></i>çŸ¥è­˜æœç´¢</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-chat-quote me-2"></i>è·¨éšæ®µçŸ¥è­˜æœç´¢</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="search-query" placeholder="è¼¸å…¥æœç´¢é—œéµè©...">
                        <button class="btn btn-primary" onclick="searchKnowledge()">
                            <i class="bi bi-search me-2"></i>æœç´¢
                        </button>
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div id="status-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-info-circle me-2"></i>ç³»çµ±ç‹€æ…‹</h2>
                <button class="btn btn-outline-secondary" onclick="showSection('dashboard')">
                    <i class="bi bi-arrow-left me-1"></i>è¿”å›å„€è¡¨æ¿
                </button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-activity me-2"></i>æœå‹™å™¨ç‹€æ…‹</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <span class="badge bg-success me-2">é‹è¡Œä¸­</span>
                                HTTP æœå‹™å™¨ (ç«¯å£ 5005)
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-success me-2">é€£æ¥æ­£å¸¸</span>
                                PostgreSQL æ•¸æ“šåº«
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-success me-2">å°±ç·’</span>
                                å‘é‡å­˜å„²ç³»çµ±
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clock me-2"></i>æœ€å¾Œæ›´æ–°</h5>
                        </div>
                        <div class="card-body">
                            <div id="last-update">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        let progressSocket = null;
        let websocketConnected = false;
        let websocketReconnectTimer = null;
        let fallbackPollingInterval = null;
        let activePhase = null;

        function connectProgressWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = protocol + '://' + window.location.host + '/api/ws/progress';

            if (progressSocket && (progressSocket.readyState === WebSocket.OPEN || progressSocket.readyState === WebSocket.CONNECTING)) {
                return;
            }

            try {
                progressSocket = new WebSocket(wsUrl);
            } catch (error) {
                console.error('Failed to create progress WebSocket:', error);
                scheduleWebSocketReconnect();
                return;
            }

            progressSocket.onopen = () => {
                websocketConnected = true;
                console.log('Progress WebSocket connected');
                if (websocketReconnectTimer) {
                    clearTimeout(websocketReconnectTimer);
                    websocketReconnectTimer = null;
                }
                stopProgressPolling();
                if (activePhase) {
                    fetchProgressOnce(activePhase);
                }
            };

            progressSocket.onmessage = event => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'progress' && data.progress) {
                        const phase = data.phase || (data.progress && data.progress.phase);
                        if (!activePhase || phase !== activePhase) {
                            return;
                        }
                        displayProgress(data.progress);
                        displayLogs(data.progress.logs || []);
                    }
                } catch (error) {
                    console.error('Failed to parse progress event:', error);
                }
            };

            progressSocket.onerror = event => {
                console.error('Progress WebSocket error:', event);
            };

            progressSocket.onclose = () => {
                console.warn('Progress WebSocket closed');
                websocketConnected = false;
                progressSocket = null;
                if (activePhase) {
                    startProgressPolling(activePhase);
                }
                scheduleWebSocketReconnect();
            };
        }

        function scheduleWebSocketReconnect() {
            if (websocketReconnectTimer) {
                return;
            }
            websocketReconnectTimer = setTimeout(() => {
                websocketReconnectTimer = null;
                connectProgressWebSocket();
            }, 5000);
        }

        function startProgressPolling(phase) {
            stopProgressPolling();
            if (!phase) {
                return;
            }
            fallbackPollingInterval = setInterval(() => {
                fetchProgressOnce(phase);
            }, 2000);
            fetchProgressOnce(phase);
        }

        function stopProgressPolling() {
            if (fallbackPollingInterval) {
                clearInterval(fallbackPollingInterval);
                fallbackPollingInterval = null;
            }
        }

        async function fetchProgressOnce(phase) {
            if (!phase) {
                return;
            }
            try {
                const response = await fetch('/api/phases/progress/' + phase);
                if (!response.ok) {
                    if (response.status === 404) {
                        return;
                    }
                    throw new Error('HTTP ' + response.status);
                }
                const progress = await response.json();
                if (!activePhase || phase === activePhase) {
                    displayProgress(progress);
                    displayLogs(progress.logs || []);
                }
            } catch (error) {
                console.error('Progress fetch failed:', error);
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update active nav link
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Find and activate the corresponding nav link
            const activeLink = document.querySelector('[href="#' + sectionName + '"]');
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }

        async function triggerPhase(phase) {
            const statusDiv = document.getElementById('phase-status');
            const progressContainer = document.getElementById('progress-container');
            const logsContainer = document.getElementById('logs-container');

            activePhase = phase;
            stopProgressPolling();

            statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>åŸ·è¡Œä¸­...</div>';

            // Show progress and logs containers
            progressContainer.style.display = 'block';
            logsContainer.style.display = 'block';

            displayProgress({
                phase: phase,
                status: 'running',
                progress: 0,
                message: 'ç­‰å¾…éšæ®µå•Ÿå‹•ä¸­...'
            });
            displayLogs([]);

            console.log('Starting phase:', phase);

            try {
                const response = await fetch('/api/phases/trigger/' + phase, {
                    method: 'POST'
                });
                const result = await response.json();

                console.log('Trigger response:', response.status, result);

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>' + result.message + '</div>';

                    if (websocketConnected) {
                        fetchProgressOnce(phase);
                    } else {
                        startProgressPolling(phase);
                    }
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>éŒ¯èª¤: ' + result.error + '</div>';
                    progressContainer.style.display = 'none';
                    logsContainer.style.display = 'none';
                    activePhase = null;
                }
            } catch (error) {
                console.error('Trigger error:', error);
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>ç¶²è·¯éŒ¯èª¤: ' + error.message + '</div>';
                progressContainer.style.display = 'none';
                logsContainer.style.display = 'none';
                activePhase = null;
            }
        }

        async function loadVectorStats() {
            const statsDiv = document.getElementById('vector-stats');
            statsDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split me-2"></i>è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch('/api/vector/stats');
                const stats = await response.json();

                const phaseNames = {
                    'phase1': 'Phase 1 - æ¶æ§‹åˆ†æ',
                    'phase1_post': 'Phase 1 Post - æ±ºç­–æ•´åˆ',
                    'phase1_put': 'Phase 1 Put - æ±ºç­–å¥—ç”¨',
                    'phase2_prefix': 'Phase 2 Prefix - åˆ—ç´šæ·±åº¦åˆ†æ',
                    'phase2': 'Phase 2 - AI åˆ†æ',
                    'phase3': 'Phase 3 - æ¥­å‹™ç¸½çµ'
                };

                const phaseStats = (stats && typeof stats === 'object' && stats.phases)
                    ? stats.phases
                    : Object.keys(stats || {}).reduce((acc, key) => {
                        if (key !== 'total_chunks' && typeof stats[key] === 'number') {
                            acc[key] = stats[key];
                        }
                        return acc;
                    }, {});

                let html = '';
                if (typeof stats.total_chunks === 'number') {
                    html += '<div class="alert alert-secondary d-flex justify-content-between align-items-center">';
                    html += '<span><i class="bi bi-collection me-2"></i>å‘é‡åˆ†ç‰‡ç¸½æ•¸</span>';
                    html += '<strong>' + stats.total_chunks + '</strong>';
                    html += '</div>';
                }

                const entries = Object.entries(phaseStats || {});
                if (entries.length === 0) {
                    html += '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>ç›®å‰æ²’æœ‰ä»»ä½•çŸ¥è­˜å­˜å…¥å‘é‡åº«</div>';
                } else {
                    html += '<div class="row">';
                    entries.forEach(([phase, count]) => {
                        const displayName = phaseNames[phase] || phase;
                        html += '<div class="col-md-4 mb-3">';
                        html += '<div class="card h-100">';
                        html += '<div class="card-body text-center">';
                        html += '<i class="bi bi-database display-4 text-primary mb-2"></i>';
                        html += '<h6>' + displayName + '</h6>';
                        html += '<h4 class="text-primary">' + count + '</h4>';
                        html += '<small class="text-muted">çŸ¥è­˜æ¢ç›®</small>';
                        html += '</div></div></div>';
                    });
                    html += '</div>';
                }

                statsDiv.innerHTML = html;
            } catch (error) {
                statsDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        async function loadPhaseKnowledge() {
            const phase = document.getElementById('phase-select').value;
            const knowledgeDiv = document.getElementById('phase-knowledge');
            knowledgeDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split me-2"></i>è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch('/api/vector/knowledge/' + phase);
                const knowledge = await response.json();

                if (knowledge.length === 0) {
                    knowledgeDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>è©²éšæ®µæ²’æœ‰çŸ¥è­˜å…§å®¹</div>';
                    return;
                }

                let html = '<div class="accordion" id="knowledgeAccordion">';
                knowledge.forEach((item, index) => {
                    const preview = item.content.length > 100 ? item.content.substring(0, 100) + '...' : item.content;
                    html += '<div class="accordion-item">';
                    html += '<h2 class="accordion-header" id="heading' + index + '">';
                    html += '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse' + index + '">';
                    html += '<i class="bi bi-file-text me-2"></i>' + preview;
                    html += '</button></h2>';
                    html += '<div id="collapse' + index + '" class="accordion-collapse collapse" data-bs-parent="#knowledgeAccordion">';
                    html += '<div class="accordion-body"><pre class="mb-0">' + item.content + '</pre></div>';
                    html += '</div></div>';
                });
                html += '</div>';

                knowledgeDiv.innerHTML = html;
            } catch (error) {
                knowledgeDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        async function searchKnowledge() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert('è«‹è¼¸å…¥æœç´¢é—œéµè©');
                return;
            }

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split me-2"></i>æœç´¢ä¸­...</div>';

            try {
                const response = await fetch('/api/vector/search?q=' + encodeURIComponent(query));
                const results = await response.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>æ²’æœ‰æ‰¾åˆ°ç›¸é—œçµæœ</div>';
                    return;
                }

                let html = '<div class="list-group">';
                results.forEach((result, index) => {
                    html += '<div class="list-group-item">';
                    html += '<div class="d-flex w-100 justify-content-between">';
                    html += '<h6 class="mb-1"><i class="bi bi-search me-2"></i>æœç´¢çµæœ ' + (index + 1) + '</h6>';
                    html += '<small class="text-muted">ç›¸ä¼¼åº¦: ' + (result.score * 100).toFixed(1) + '%</small>';
                    html += '</div>';
                    html += '<pre class="mb-1 mt-2">' + result.content + '</pre>';
                    html += '</div>';
                });
                html += '</div>';

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>æœç´¢å¤±æ•—: ' + error.message + '</div>';
            }
        }

        async function loadKnowledgeFiles() {
            const listContainer = document.getElementById('knowledge-files');
            const detailsContainer = document.getElementById('knowledge-details');
            if (!listContainer) {
                return;
            }

            listContainer.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split me-2"></i>è¼‰å…¥ä¸­...</div>';
            if (detailsContainer) {
                detailsContainer.innerHTML = 'é¸æ“‡å·¦å´æª”æ¡ˆä»¥æŸ¥çœ‹å…§å®¹ã€‚';
            }

            try {
                const response = await fetch('/api/knowledge/files');
                const files = await response.json();

                if (!Array.isArray(files) || files.length === 0) {
                    listContainer.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>å°šæœªç”¢ç”Ÿä»»ä½•çŸ¥è­˜æª”æ¡ˆ</div>';
                    return;
                }

                let html = '<div class="list-group">';
                files.forEach(file => {
                    const modTime = file.mod_time ? new Date(file.mod_time).toLocaleString('zh-TW') : '';
                    const sizeKB = file.size_bytes ? (file.size_bytes / 1024).toFixed(1) : '0';
                    html += '<button type="button" class="list-group-item list-group-item-action" onclick="showKnowledgeFile(' + JSON.stringify(file.name) + ')">';
                    html += '<div class="d-flex w-100 justify-content-between">';
                    html += '<strong>' + file.name + '</strong>';
                    html += '<small class="text-muted">' + modTime + '</small>';
                    html += '</div>';
                    html += '<small class="text-muted">' + sizeKB + ' KB</small>';
                    html += '</button>';
                });
                html += '</div>';

                listContainer.innerHTML = html;
            } catch (error) {
                listContainer.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        async function showKnowledgeFile(name) {
            const contentContainer = document.getElementById('knowledge-content');
            const detailsContainer = document.getElementById('knowledge-details');
            if (!contentContainer) {
                return;
            }

            contentContainer.textContent = 'è¼‰å…¥ä¸­...';
            if (detailsContainer) {
                detailsContainer.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-2"></i>è¼‰å…¥ä¸­...</span>';
            }

            try {
                const response = await fetch('/api/knowledge/files/' + encodeURIComponent(name));
                const file = await response.json();

                if (!response.ok) {
                    throw new Error(file.error || 'ç„¡æ³•è¼‰å…¥æª”æ¡ˆ');
                }

                let displayContent = '';
                if (file.type === 'json') {
                    displayContent = JSON.stringify(file.content, null, 2);
                } else {
                    displayContent = file.content;
                }

                const modTime = file.mod_time ? new Date(file.mod_time).toLocaleString('zh-TW') : '';
                const sizeKB = file.size_bytes ? (file.size_bytes / 1024).toFixed(1) : '0';

                contentContainer.textContent = displayContent || 'æª”æ¡ˆç‚ºç©º';
                if (detailsContainer) {
                    let detailsHTML = '<div><strong>' + file.name + '</strong></div>';
                    detailsHTML += '<div class="text-muted small">æ›´æ–°æ™‚é–“: ' + modTime + '</div>';
                    detailsHTML += '<div class="text-muted small">æª”æ¡ˆå¤§å°: ' + sizeKB + ' KB</div>';
                    if (file.parse_error) {
                        detailsHTML += '<div class="text-warning small"><i class="bi bi-exclamation-triangle me-1"></i>' + file.parse_error + '</div>';
                    }
                    detailsContainer.innerHTML = detailsHTML;
                }
            } catch (error) {
                contentContainer.textContent = '';
                if (detailsContainer) {
                    detailsContainer.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            loadVectorStats();
            loadKnowledgeFiles();
            connectProgressWebSocket();
            updateLastUpdate();
            initializeQuerySuggestions();
        };

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').innerHTML =
                '<i class="bi bi-clock me-2"></i>' + now.toLocaleString('zh-TW');
        }

        // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡æ™‚é–“
        setInterval(updateLastUpdate, 60000);

        async function prepareKnowledge() {
            const statusDiv = document.getElementById('prepare-status');
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨æº–å‚™çŸ¥è­˜åº«ï¼Œè«‹ç¨å€™...</div>';

            try {
                const response = await fetch('/api/knowledge/prepare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>' + result.message + '</div>';
                    // é‡æ–°è¼‰å…¥å‘é‡çµ±è¨ˆä¿¡æ¯
                    setTimeout(() => {
                        loadVectorStats();
                    }, 1000);
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>æº–å‚™å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>ç¶²è·¯éŒ¯èª¤: ' + error.message + '</div>';
            }
        }

        async function executeQuery() {
            const queryInput = document.getElementById('query-input');
            const resultsDiv = document.getElementById('query-results');
            const resultContent = document.getElementById('query-result-content');

            const question = queryInput.value.trim();
            if (!question) {
                alert('è«‹è¼¸å…¥æŸ¥è©¢å•é¡Œ');
                return;
            }

            // é¡¯ç¤ºé€²åº¦æ¢
            const progressContainer = document.createElement('div');
            progressContainer.className = 'mb-3';
            progressContainer.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-gear me-2"></i>æ­£åœ¨è™•ç†æŸ¥è©¢...</h6>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="queryProgress"></div>
                    </div>
                    <small class="text-muted mt-1" id="progressText">æ­£åœ¨åˆ†ææŸ¥è©¢æ„åœ–...</small>
                </div>
            `;
            resultContent.innerHTML = '';
            resultContent.appendChild(progressContainer);

            const progressBar = document.getElementById('queryProgress');
            const progressText = document.getElementById('progressText');

            // æ¨¡æ“¬é€²åº¦æ›´æ–°
            const progressSteps = [
                { width: '20%', text: 'æ­£åœ¨åˆ†ææŸ¥è©¢æ„åœ–...', delay: 500 },
                { width: '40%', text: 'æ­£åœ¨æª¢ç´¢ç›¸é—œçŸ¥è­˜...', delay: 1000 },
                { width: '60%', text: 'æ­£åœ¨ç”Ÿæˆ SQL æŸ¥è©¢...', delay: 1500 },
                { width: '80%', text: 'æ­£åœ¨åŸ·è¡Œæ•¸æ“šåº«æŸ¥è©¢...', delay: 2000 },
                { width: '100%', text: 'æ­£åœ¨ç”Ÿæˆæ¥­å‹™æ´å¯Ÿ...', delay: 2500 }
            ];

            let currentStep = 0;
            const updateProgress = () => {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    progressBar.style.width = step.width;
                    progressText.textContent = step.text;
                    currentStep++;
                    setTimeout(updateProgress, step.delay);
                }
            };

            // é–‹å§‹é€²åº¦æ›´æ–°
            updateProgress();

            resultsDiv.style.display = 'block';

            try {
                const response = await fetch('/api/knowledge/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question
                    })
                });

                const result = await response.json();

                // å®Œæˆé€²åº¦æ¢
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                progressText.textContent = 'æŸ¥è©¢å®Œæˆï¼';

                // å»¶é²ä¸€ä¸‹å†é¡¯ç¤ºçµæœ
                setTimeout(() => {
                    if (response.ok && result.success) {
                        // æ ¼å¼åŒ–çµæœé¡¯ç¤º
                        let html = '<div class="alert alert-success mb-3">';
                        html += '<h6><i class="bi bi-check-circle me-2"></i>æŸ¥è©¢æˆåŠŸ</h6>';
                        html += '<p class="mb-1"><strong>å•é¡Œï¼š</strong>' + escapeHtml(result.query) + '</p>';
                        if (result.count !== undefined) {
                            html += '<p class="mb-1"><strong>çµæœæ•¸é‡ï¼š</strong>' + result.count + ' æ¢è¨˜éŒ„</p>';
                        }
                        html += '</div>';

                        // é¡¯ç¤º SQL æŸ¥è©¢
                        if (result.sql) {
                            html += '<div class="mb-3">';
                            html += '<h6><i class="bi bi-code-slash me-2"></i>ç”Ÿæˆçš„ SQL æŸ¥è©¢</h6>';
                            html += '<pre class="bg-light p-2 rounded"><code>' + escapeHtml(result.sql) + '</code></pre>';
                            html += '</div>';
                        }

                        // é¡¯ç¤ºæŸ¥è©¢çµæœ
                        if (result.results && result.results.length > 0) {
                            html += '<div class="mb-3">';
                            html += '<h6><i class="bi bi-table me-2"></i>æŸ¥è©¢çµæœ</h6>';
                            html += '<div class="table-responsive">';
                            html += '<table class="table table-striped table-hover">';
                            
                            // è¡¨é ­
                            const firstRow = result.results[0];
                            html += '<thead class="table-dark"><tr>';
                            Object.keys(firstRow).forEach(key => {
                                html += '<th>' + escapeHtml(key) + '</th>';
                            });
                            html += '</tr></thead>';
                            
                            // æ•¸æ“šè¡Œ
                            html += '<tbody>';
                            result.results.forEach(row => {
                                html += '<tr>';
                                Object.values(row).forEach(value => {
                                    const displayValue = value === null ? '<em class="text-muted">NULL</em>' : escapeHtml(String(value));
                                    html += '<td>' + displayValue + '</td>';
                                });
                                html += '</tr>';
                            });
                            html += '</tbody></table></div>';
                            html += '</div>';
                        }

                        // é¡¯ç¤ºè§£é‡‹
                        if (result.explanation) {
                            html += '<div class="mb-3">';
                            html += '<h6><i class="bi bi-info-circle me-2"></i>æŸ¥è©¢è§£é‡‹</h6>';
                            html += '<p class="text-muted">' + escapeHtml(result.explanation) + '</p>';
                            html += '</div>';
                        }

                        // é¡¯ç¤ºæ¥­å‹™æ´å¯Ÿ
                        if (result.insights) {
                            html += '<div class="mb-3">';
                            html += '<h6><i class="bi bi-lightbulb me-2"></i>æ¥­å‹™æ´å¯Ÿ</h6>';
                            html += '<div class="alert alert-info">' + escapeHtml(result.insights).replace(/\n/g, '<br>') + '</div>';
                            html += '</div>';
                        }

                        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                        if (result.error) {
                            html += '<div class="alert alert-warning">';
                            html += '<h6><i class="bi bi-exclamation-triangle me-2"></i>æ³¨æ„</h6>';
                            html += '<p class="mb-0">' + escapeHtml(result.error) + '</p>';
                            html += '</div>';
                        }

                        resultContent.innerHTML = html;
                    } else {
                        resultContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>æŸ¥è©¢å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
                    }
                }, 500);
            } catch (error) {
                resultContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>ç¶²è·¯éŒ¯èª¤: ' + error.message + '</div>';
            }
        }

        function displayProgress(progress) {
            const progressBarsDiv = document.getElementById('progress-bars');

            if (!progress) {
                progressBarsDiv.innerHTML = '';
                return;
            }

            const status = progress.status || 'running';
            const statusLabelMap = {
                running: 'åŸ·è¡Œä¸­',
                completed: 'å®Œæˆ',
                failed: 'å¤±æ•—',
                idle: 'å°±ç·’'
            };
            const badgeLabel = statusLabelMap[status] || status;
            const percentage = Math.max(0, Math.min(100, Math.round(progress.progress || 0)));
            const phaseName = escapeHtml(getPhaseDisplayName(progress.phase));
            const baseMessage = progress.message || (status === 'completed' ? 'å®Œæˆ' : status === 'failed' ? 'åŸ·è¡Œå¤±æ•—' : 'è™•ç†ä¸­...');
            const message = escapeHtml(baseMessage);
            const errorDetail = status === 'failed' ? escapeHtml(progress.error || '') : '';
            const currentStep = progress.current_step ? escapeHtml(progress.current_step) : '';

            let barClasses = 'progress-bar';
            let badgeClass = 'bg-info';
            let autoStop = false;

            if (status === 'completed') {
                barClasses += ' bg-success';
                badgeClass = 'bg-success';
                autoStop = true;
            } else if (status === 'failed') {
                barClasses += ' bg-danger';
                badgeClass = 'bg-danger';
                autoStop = true;
            } else {
                barClasses += ' progress-bar-striped progress-bar-animated';
            }

            let html = '<div class="progress-item">';
            html += '<div class="d-flex justify-content-between align-items-center mb-1">';
            html += '<span>' + phaseName + '</span>';
            html += '<div class="d-flex align-items-center gap-2">';
            html += '<span class="text-muted small">' + percentage + '%</span>';
            html += '<span class="badge ' + badgeClass + ' text-uppercase">' + escapeHtml(badgeLabel) + '</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="progress" style="height: 20px;">';
            html += '<div class="' + barClasses + '" role="progressbar" style="width: ' + percentage + '%" aria-valuenow="' + percentage + '" aria-valuemin="0" aria-valuemax="100">';
            html += message;
            html += '</div></div>';
            if (errorDetail) {
                html += '<div class="text-danger small mt-2"><i class="bi bi-exclamation-triangle me-1"></i>' + errorDetail + '</div>';
            }
            if (currentStep) {
                html += '<div class="text-muted small mt-1">' + currentStep + '</div>';
            }
            html += '</div>';

            progressBarsDiv.innerHTML = html;

            if (autoStop) {
                stopProgressPolling();
            }
        }

        function displayLogs(logs) {
            const logsContentDiv = document.getElementById('logs-content');

            if (!logs || logs.length === 0) {
                logsContentDiv.innerHTML = '<div class="text-muted">ç­‰å¾…æ—¥èªŒè¼¸å‡º...</div>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                let timestamp = '';
                if (log.timestamp) {
                    const dateValue = new Date(log.timestamp);
                    if (!Number.isNaN(dateValue.getTime())) {
                        timestamp = dateValue.toLocaleTimeString('zh-TW');
                    }
                }
                const level = (log.level || 'info').toLowerCase();
                const levelClass = 'log-level-' + level;
                const message = escapeHtml(log.message || '');
                html += '<div class="log-entry">';
                html += '<span class="log-timestamp">[' + timestamp + ']</span>';
                html += '<span class="' + levelClass + '">[' + level.toUpperCase() + ']</span> ';
                html += '<span>' + message + '</span>';
                html += '</div>';
            });

            logsContentDiv.innerHTML = html;

            // Auto scroll to bottom
            logsContentDiv.scrollTop = logsContentDiv.scrollHeight;
        }

        function getPhaseDisplayName(phase) {
            const names = {
                'phase1': 'Phase 1 - æ•¸æ“šåº«æ¶æ§‹åˆ†æ',
                'phase1_post': 'Phase 1 Post - å•ç­”æ±ºç­–æ•´åˆ',
                'phase1_put': 'Phase 1 Put - æ›´æ–°ç²¾ç°¡çµæœ',
                'phase2_prefix': 'Phase 2 Prefix - åˆ—ç´šæ·±åº¦åˆ†æ',
                'phase2': 'Phase 2 - AI å•†æ¥­é‚è¼¯åˆ†æ',
                'phase3': 'Phase 3 - æ¥­å‹™é‚è¼¯ç¸½çµ'
            };
            return names[phase] || phase;
        }

        // æŸ¥è©¢å»ºè­°åŠŸèƒ½
        let suggestionTimeout = null;

        function initializeQuerySuggestions() {
            const queryInput = document.getElementById('query-input');
            if (queryInput) {
                queryInput.addEventListener('input', handleQueryInput);
                queryInput.addEventListener('focus', showSuggestions);
                queryInput.addEventListener('blur', hideSuggestionsDelayed);
            }
        }

        function handleQueryInput(event) {
            const partialQuery = event.target.value.trim();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨
            if (suggestionTimeout) {
                clearTimeout(suggestionTimeout);
            }
            
            // å¦‚æœè¼¸å…¥å¤ªçŸ­ï¼Œéš±è—å»ºè­°
            if (partialQuery.length < 2) {
                hideSuggestions();
                return;
            }
            
            // å»¶é² 500ms å¾Œç²å–å»ºè­°ï¼Œé¿å…éæ–¼é »ç¹çš„è«‹æ±‚
            suggestionTimeout = setTimeout(() => {
                fetchQuerySuggestions(partialQuery);
            }, 500);
        }

        async function fetchQuerySuggestions(partialQuery) {
            try {
                const response = await fetch('/api/knowledge/suggest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partial_query: partialQuery
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displaySuggestions(result.suggestions);
                } else {
                    hideSuggestions();
                }
            } catch (error) {
                console.error('ç²å–å»ºè­°å¤±æ•—:', error);
                hideSuggestions();
            }
        }

        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('query-suggestions');
            const suggestionsList = document.getElementById('suggestions-list');
            
            if (!suggestions || suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            
            let html = '';
            suggestions.forEach((suggestion, index) => {
                const suggestionId = 'suggestion-' + index;
                html += '<button type="button" class="btn btn-outline-secondary btn-sm me-1 mb-1 suggestion-btn" id="' + suggestionId + '" data-suggestion="' + escapeHtml(suggestion) + '">';
                html += '<i class="bi bi-lightbulb me-1"></i>' + escapeHtml(suggestion);
                html += '</button>';
            });
            
            suggestionsList.innerHTML = html;
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.suggestion-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const suggestion = this.getAttribute('data-suggestion');
                    selectSuggestion(suggestion);
                });
            });
            
            suggestionsDiv.style.display = 'block';
        }

        function hideSuggestions() {
            const suggestionsDiv = document.getElementById('query-suggestions');
            suggestionsDiv.style.display = 'none';
        }

        function hideSuggestionsDelayed() {
            // å»¶é²éš±è—ï¼Œè®“ç”¨æˆ¶æœ‰æ™‚é–“é»æ“Šå»ºè­°
            setTimeout(() => {
                hideSuggestions();
            }, 200);
        }

        function showSuggestions() {
            const queryInput = document.getElementById('query-input');
            const partialQuery = queryInput.value.trim();
            
            if (partialQuery.length >= 2) {
                const suggestionsDiv = document.getElementById('query-suggestions');
                if (suggestionsDiv.style.display === 'none') {
                    // å¦‚æœæœ‰å»ºè­°å…§å®¹ï¼Œé¡¯ç¤ºå®ƒå€‘
                    const suggestionsList = document.getElementById('suggestions-list');
                    if (suggestionsList && suggestionsList.innerHTML.trim()) {
                        suggestionsDiv.style.display = 'block';
                    }
                }
            }
        }

        function selectSuggestion(suggestion) {
            const queryInput = document.getElementById('query-input');
            queryInput.value = suggestion;
            hideSuggestions();
            queryInput.focus();
        }
    </script>
</body>
</html>
